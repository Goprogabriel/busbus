rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ðŸ”’ Alt er lukket som udgangspunkt
    match /{document=**} {
      allow read, write: if false;
    }

    // ðŸ” Auth collection - kun for at verificere admin brugere
    match /auth/{userId} {
      // Kun autentificerede brugere kan lÃ¦se deres egen auth dokument
      allow read: if request.auth != null && request.auth.uid == userId;
      
      // Ingen mÃ¥ skrive/oprette/slette
      allow write: if false;
    }

    // âœ… Submissions er Ã¥ben for create
    match /submissions/{docId} {

      // Alle mÃ¥ oprette (uden login)
      allow create: if isValidSubmission();

      // Kun admins mÃ¥ lÃ¦se, opdatere eller slette
      allow read, update, delete: if isAdmin();
    }

    // HjÃ¦lpefunktion til at tjekke om bruger er admin
    function isAdmin() {
      return request.auth != null && 
             exists(/databases/$(database)/documents/auth/$(request.auth.uid));
    }

    function isValidSubmission() {
      return
        // Tillad disse felter (matcher din app.js struktur)
        request.resource.data.keys().hasOnly([
          "createdAt",
          "language",
          "answers",
          "userAgent",
          "referrer",
          "metadata"
        ]) &&

        // createdAt skal vÃ¦re timestamp
        request.resource.data.createdAt is timestamp &&

        // language skal vÃ¦re string (2-10 tegn, fx 'da' eller 'en')
        request.resource.data.language is string &&
        request.resource.data.language.size() >= 2 &&
        request.resource.data.language.size() <= 10 &&

        // answers skal vÃ¦re et map/objekt
        request.resource.data.answers is map &&

        // userAgent og referrer mÃ¥ vÃ¦re string eller null
        (request.resource.data.userAgent is string || request.resource.data.userAgent == null) &&
        (request.resource.data.referrer is string || request.resource.data.referrer == null);
    }
  }
}
